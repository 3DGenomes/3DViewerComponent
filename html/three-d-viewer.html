<dom-module id="three-d-viewer">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }

      .three-d-viewer-wrapper {
        position: relative;
        height: 100%;
        width: 100%;

      }

      .three-d-viewer-wrapper:before {
        content: "";
        display: block;
      }

      .viewer-anchor {
        position: relative;
        display: inline-block;
        height: 100%;
        width: 100%;
      }

      .arrow-left {
        font-size: 25px;
        position: absolute;
        top: 45%;
        left: 4%;
        cursor: pointer;
        transform:rotate(135deg);
        -webkit-transform:rotate(135deg);
      }

      .arrow-right {
        font-size: 25px;
        position: absolute;
        top: 45%;
        right: 4%;
        cursor: pointer;
        transform:rotate(-45deg);
        -webkit-transform:rotate(-45deg);
      }

      .viewer {
        height: 100%;
        width: 99%;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 1px solid #e0e0e0;
        overflow: hidden;
      }

      .img-box-rel-size {
        width: 100%;
        height: 100%;
      }

      [class^=arrow-]{
        z-index: 2;
        border:       solid #222;
        border-width: 0 .2em .2em 0;
        display:      inline-block;
        padding:      .20em;
      }

      .loader {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 44%;
        left: 0;
        font-size: 20px;
        text-align: center;
        z-index: 3;
      }

      .loader.error {
        z-index: 1;
      }

    </style>

    <!-------------------- Loading Requests START -------------------->

    <!--Loading Request: DownloadPath-->
    <iron-ajax
            id="downloadPaths"
            url="http://localhost:8000/api/v1/assets/[[assetDataId]]/directDownloadUrl"
            handle-as="json"
            on-response="onDownloadPathFetched"
            ></iron-ajax>

    <!-------------------- Loading Requests END -------------------->

    <div class="viewer-anchor">
      <template is="dom-repeat" items="{{previews}}">

        <template is="dom-if" if="{{showPreview(item)}}">
          <div class="img-box-rel-size">

            <div class="three-d-viewer-wrapper">
              <div class="viewer" id="three-d-viewer-{{index}}"></div>
            </div>

          </div>
        </template>

      </template>

      <template is="dom-if" if="{{showViewerArrows(previews)}}">
        <div class="arrow-left" on-click="showPreviousPreview"></div>
        <div class="arrow-right" on-click="showNextPreview"></div>
      </template>

      <template is="dom-if" if="{{!isThreeDViewerReady}}">
        <div class$="loader {{computeErrorClass(loadingMessage)}}">[[loadingMessage]]</div>
      </template>
    </div>

  </template>

  <link rel="import" href="../../polymer/polymer.html">
  <link rel="import" href="../../iron-ajax/iron-ajax.html">
  <script src="../../jquery/jquery.min.js"></script>
  <script src="../../three.js/build/three.js"></script>
  <script src="../../three.js/examples/js/loaders/OBJLoader.js"></script>
  <script src="../../three.js/examples/js/loaders/STLLoader.js"></script>
  <script src="../../three.js/examples/js/libs/tween.min.js"></script>
  <script src="../../three.js/examples/js/controls/OrbitControls.js"></script>

  <script src="../js/THREEx.WindowResize.js" type="text/javascript"></script>
  <script src="../js/utils.js" type="text/javascript"></script>
  <script src="../js/handlebars-v3.0.3.js" type="text/javascript"></script>
  <script src="../js/threeView.js" type="text/javascript"></script>

  <script>
    'use strict';

    var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

    function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

    var ThreeDViewer = function () {
      function ThreeDViewer() {
        _classCallCheck(this, ThreeDViewer);
      }

      _createClass(ThreeDViewer, [{
        key: 'beforeRegister',
        value: function beforeRegister() {
          this.is = 'three-d-viewer';
          this.properties = {
            previews: {
              type: Array,
              observer: 'previewsChanged'
            },
            assetDataId: {
              type: String,
              value: ''
            },
            color: {
              type: String,
              value: 'cccccc',
              observer: '_changeModelColor'
            },
            options: {
              type: Object,
              value: function value() {
                return {};
              }
            }
          };
        }
      }, {
        key: 'unloadObj',
        value: function unloadObj() {
          this.isThreeDViewerReady = false;
        }
      }, {
        key: 'showPreview',
        value: function showPreview(preview) {
          return this.selectedPreview === preview;
        }
      }, {
        key: 'showViewerArrows',
        value: function showViewerArrows(previews) {
          return previews && previews.length > 1;
        }
      }, {
        key: 'showPreviousPreview',
        value: function showPreviousPreview() {
          this.unloadObj();
          this.selectedIndex = (this.selectedIndex - 1) % this.previews.length;
          if (this.selectedIndex < 0) {
            this.selectedIndex = this.previews.length - 1;
          }
          this.getPreviewPath(this.previews[this.selectedIndex]);
        }
      }, {
        key: 'showNextPreview',
        value: function showNextPreview() {
          this.unloadObj();
          this.selectedIndex = (this.selectedIndex + 1) % this.previews.length;
          this.getPreviewPath(this.previews[this.selectedIndex]);
        }
      }, {
        key: 'renderModel',
        value: function renderModel(index) {
          var _this = this;

          index = index || 0;
          var elem = $('#three-d-viewer-' + index);
          var width = parseInt(elem.css('width'),10);
          var height = parseInt(elem.css('height'),10);
          Viewer.init(elem, { width: width, height: height});
          Viewer.resize();
          Viewer.loadObject(this.currentModelUrl, this.fileExtension, function () {
            _this.isThreeDViewerReady = true;
          }, function () {
            _this.setLoadingFileErrorMessage();
            _this.isThreeDViewerReady = false;
          });
        }
      }, {
        key: 'computeErrorClass',
        value: function computeErrorClass(loadingMessage) {
          return loadingMessage === this.LOADING_ERROR ? 'error' : '';
        }
      }, {
        key: 'getPreviewPath',
        value: function getPreviewPath(prev) {
          var _this2 = this;

          this.set('loadingMessage', 'Loading...');
          var preview = prev || this.previews[0];
          this.selectedPreview = preview;
          this.selectedIndex = this.previews.indexOf(preview);

          this.fileExtension = preview.file_type;
          this.currentModelUrl = preview.file_url;
          setTimeout(function () {
            _this2.renderModel();
          });
        }
      }, {
        key: 'onDownloadPathFetched',
        value: function onDownloadPathFetched(request) {
          if (request.detail.response) {
            this.currentModelUrl = request.detail.response.download_url_secure;
            this.renderModel();
          }
        }
      }, {
        key: 'setLoadingFileErrorMessage',
        value: function setLoadingFileErrorMessage() {
          this.set('loadingMessage', this.LOADING_ERROR);
        }
      }, {
        key: 'previewsChanged',
        value: function previewsChanged() {
          if (this.previews && this.previews.length > 0) {
            this.isThreeDViewerReady = false;
            this.getPreviewPath();
          }
        }
      }, {
        key: 'ready',
        value: function ready() {
        }
      }, {
        key: '_changeModelColor',
        value: function _changeModelColor() {
        }
      }, {
        key: 'LOADING_ERROR',
        get: function get() {
          return 'Could not load file.';
        }
      }]);

      return ThreeDViewer;
    }();

    Polymer(ThreeDViewer);
    //# sourceMappingURL=three-d-viewer.js.map

  </script>
</dom-module>
